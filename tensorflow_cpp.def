Bootstrap: docker
From: tensorflow/tensorflow:devel

%labels
    Author JuanDigut
    Description Contenedor para ejecutar ejemplos de TensorFlow C++ del Proyecto Final
    Version 1.0

%post
    set -ex
    
    # Instalar dependencias (mismo que en Dockerfile)
    apt-get update && apt-get install -y \
        cmake git pkg-config rsync \
        && rm -rf /var/lib/apt/lists/*

    # Clonar repositorio (mismo que en Dockerfile)
    git clone https://github.com/JuanDigut/Proyectofinalprogra.git /opt/proyecto

    # Configurar TensorFlow (mismo que en Dockerfile)
    pip install --upgrade pip
    pip install tensorflow==2.13.1

    mkdir -p /opt/tensorflow/lib /opt/tensorflow/include

    # Get TensorFlow paths
    TENSORFLOW_PATH=$(python3 -c "import tensorflow as tf; print(tf.sysconfig.get_lib())")
    TENSORFLOW_INCLUDE=$(python3 -c "import tensorflow as tf; print(tf.sysconfig.get_include())")
    
    echo "TensorFlow path: $TENSORFLOW_PATH"
    echo "TensorFlow include: $TENSORFLOW_INCLUDE"
    
    # List available libraries
    echo "=== Available .so files ==="
    ls -la ${TENSORFLOW_PATH}/*.so* || true
    
    # Copy ALL TensorFlow libraries
    cp -P ${TENSORFLOW_PATH}/*.so* /opt/tensorflow/lib/ 2>/dev/null || true
    
    # Create symlinks for the linker
    cd /opt/tensorflow/lib
    echo "=== Copied libraries ==="
    ls -la
    
    # Create symlinks if versioned files exist
    for lib in libtensorflow_cc libtensorflow_framework; do
        if [ -f "${lib}.so.2" ]; then
            ln -sf ${lib}.so.2 ${lib}.so
        fi
    done
    
    echo "=== After symlinks ==="
    ls -la
    
    # Copy headers
    cp -r ${TENSORFLOW_INCLUDE}/* /opt/tensorflow/include/

    # Update library cache
    echo "/opt/tensorflow/lib" > /etc/ld.so.conf.d/tensorflow.conf
    ldconfig

    # Compilar el proyecto (mismo que en Dockerfile)
    cd /opt/proyecto
    rm -rf build
    mkdir -p build && cd build
    
    export LD_LIBRARY_PATH=/opt/tensorflow/lib:$LD_LIBRARY_PATH
    cmake -DTENSORFLOW_DIR=/opt/tensorflow \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_FLAGS="-I/opt/tensorflow/include" \
          -DCMAKE_EXE_LINKER_FLAGS="-L/opt/tensorflow/lib -Wl,-rpath,/opt/tensorflow/lib" \
          ..
    make VERBOSE=1 -j$(nproc)

%environment
    export TENSORFLOW_DIR=/opt/tensorflow
    export LD_LIBRARY_PATH=/opt/tensorflow/lib:$LD_LIBRARY_PATH
    export PATH=/opt/proyecto/build/examples:$PATH
    export TF_CPP_MIN_LOG_LEVEL=2

%runscript
    echo "=== Contenedor TensorFlow C++ - Proyecto Final ==="
    echo ""
    echo "Programas disponibles:"
    echo "  - basic_operations       : Operaciones básicas con tensores"
    echo "  - linear_regression      : Modelo de regresión lineal"
    echo "  - neural_network         : Clasificación con red neuronal"
    echo "  - anomaly_detection      : Detección de anomalías con autoencoder"
    echo "  - time_series_prediction : Predicción de series temporales"
    echo ""
    exec "$@"

%help
    Contenedor con TensorFlow C++ precompilado para el proyecto final.
    Este contenedor está basado en el mismo Dockerfile del proyecto.
    
    Construir:  apptainer build tensorflow_cpp.sif tensorflow_cpp.def
    
    Ejecutar:   apptainer exec tensorflow_cpp.sif basic_operations
                apptainer exec tensorflow_cpp.sif linear_regression
                apptainer exec tensorflow_cpp.sif neural_network
    
    Shell:      apptainer shell tensorflow_cpp.sif